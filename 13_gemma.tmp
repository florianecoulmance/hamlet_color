#!/bin/bash

#SBATCH --job-name=13_gemma.tmp
#SBATCH --partition=carl.p
#SBATCH --array=1-18
#SBATCH --output=/user/doau0129/work/chapter1_2//logs/13_gemma_%A_%a.out
#SBATCH --error=/user/doau0129/work/chapter1_2//logs/13_gemma_%A_%a.err
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=1
#SBATCH --mem-per-cpu=40G
#SBATCH --time=04:00:00


body() {
	IFS= read -r header
	printf '%s\n' "$header"
	"$@"
}


fam=/user/doau0129/work/chapter1_2//outputs/gxp/GxP_plink_binary.fam


INPUT_TR=/user/doau0129/work/chapter1_2//outputs/listoffiles/traits.fofn

#Create a job for all the possible phenotypes and the associated .fam file with just one phenotype at a time
TRAITS=$(cat ${INPUT_TR} | head -n ${SLURM_ARRAY_TASK_ID} | tail -n 1)
echo ${TRAITS}


BASE_NAME=$(echo  ${fam} | sed 's/.fam//g')
echo ${BASE_NAME}

mv ${fam} $BASE_NAME-old.fam
cp ${BASE_NAME}-old.fam ${fam}
cp ${BASE_NAME}.bed ${BASE_NAME}_${TRAITS}.bed
cp ${BASE_NAME}.bim ${BASE_NAME}_${TRAITS}.bim
cp ${BASE_NAME}.log ${BASE_NAME}_${TRAITS}.log
cp ${BASE_NAME}.nosex ${BASE_NAME}_${TRAITS}.nosex

awk -v t="${TRAITS}" 'NR==1 {for (i=1; i<=NF; i++) {f[$i] = i}} {print $(f["label"]), $(f["Within_family_ID"]), $(f["ID_father"]), $(f["ID_mother"]), $(f["Sex"]), $(f[t])}' /user/doau0129/work/chapter1_2//outputs/gxp/pheno_table.fam > ${BASE_NAME}_${TRAITS}.fam


  # 2) create relatedness matrix of samples using gemma
gemma -bfile ${BASE_NAME}_${TRAITS} -gk 1 -o ${TRAITS}

  # 3) fit linear model using gemma (-lm)
gemma -bfile ${BASE_NAME}_${TRAITS} -lm 4 -miss 0.1 -notsnp -o ${TRAITS}.lm

  # 4) fit linear mixed model using gemma (-lmm)
gemma -bfile ${BASE_NAME}_${TRAITS} -k output/${TRAITS}.cXX.txt -lmm 4 -o ${TRAITS}.lmm

  # 5) reformat output
sed 's/\trs\t/\tCHROM\tPOS\t/g; s/\([0-2][0-9]\):/\1\t/g' output/${TRAITS}.lm.assoc.txt |       cut -f 2,3,9-14 | body sort -k1,1 -k2,2n | gzip > /user/doau0129/work/chapter1_2//outputs/gxp/${TRAITS}.lm.GxP.txt.gz
sed 's/\trs\t/\tCHROM\tPOS\t/g; s/\([0-2][0-9]\):/\1\t/g' output/${TRAITS}.lmm.assoc.txt |       cut -f 2,3,8-10,13-15 | body sort -k1,1 -k2,2n | gzip > /user/doau0129/work/chapter1_2//outputs/gxp/${TRAITS}.lmm.GxP.txt.gz


rm ${BASE_NAME}_${TRAITS}.bed
rm ${BASE_NAME}_${TRAITS}.bim
rm ${BASE_NAME}_${TRAITS}.log

